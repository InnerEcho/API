<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leafy Realtime Voice Chat (WebRTC + Opus)</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 700px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .badge {
            display: inline-block;
            background: #4caf50;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 20px;
        }

        .badge-container {
            text-align: center;
            margin-bottom: 20px;
        }

        .config-section {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .input-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 600;
            font-size: 14px;
        }

        input[type="text"],
        input[type="number"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus,
        input[type="number"]:focus {
            outline: none;
            border-color: #667eea;
        }

        .status-section {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 10px;
        }

        .status-item {
            text-align: center;
        }

        .status-label {
            font-size: 11px;
            color: #666;
            margin-bottom: 5px;
        }

        .status-value {
            font-size: 16px;
            font-weight: bold;
        }

        .status-value.connected {
            color: #4caf50;
        }

        .status-value.disconnected {
            color: #f44336;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        button {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-connect {
            background: #4caf50;
            color: white;
        }

        .btn-connect:hover:not(:disabled) {
            background: #45a049;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);
        }

        .btn-disconnect {
            background: #f44336;
            color: white;
        }

        .btn-disconnect:hover:not(:disabled) {
            background: #da190b;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(244, 67, 54, 0.4);
        }

        .transcript-section {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 10px;
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .transcript-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: #333;
        }

        .message {
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 8px;
            line-height: 1.5;
        }

        .message.user {
            background: #e3f2fd;
            color: #1976d2;
        }

        .message.assistant {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        .message.system {
            background: #fff3e0;
            color: #f57c00;
            font-size: 13px;
        }

        .logs {
            background: #263238;
            color: #aed581;
            padding: 15px;
            border-radius: 10px;
            max-height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.6;
        }

        .log-entry {
            margin-bottom: 5px;
        }

        .log-entry.error {
            color: #ff5252;
        }

        .log-entry.success {
            color: #69f0ae;
        }

        .log-entry.info {
            color: #64b5f6;
        }

        .info-box {
            background: #e8f5e9;
            border-left: 4px solid #4caf50;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            font-size: 13px;
        }

        .info-box strong {
            color: #2e7d32;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üå± Leafy Realtime Voice Chat</h1>
        <p class="subtitle">OpenAI Realtime API - WebRTC ÌÖåÏä§Ìä∏</p>
        <div class="badge-container">
            <span class="badge">‚ú® WebRTC + Opus (Í≥†ÌíàÏßà)</span>
        </div>

        <div class="info-box">
            <strong>üéØ WebRTC Î∞©ÏãùÏùò Ïû•Ï†ê:</strong><br>
            ‚Ä¢ Opus ÏΩîÎç± ÏûêÎèô ÏÇ¨Ïö© (ÏµúÎåÄ 48kHz)<br>
            ‚Ä¢ ÏÑúÎ≤Ñ Î∂ÄÌïò ÏóÜÏùå (ÏßÅÏ†ë OpenAI Ïó∞Í≤∞)<br>
            ‚Ä¢ ÏûêÎèô ÎÑ§Ìä∏ÏõåÌÅ¨ Ï†ÅÏùë & Ìå®ÌÇ∑ ÏÜêÏã§ Î≥µÍµ¨
        </div>

        <!-- ÏÑ§Ï†ï ÏÑπÏÖò -->
        <div class="config-section">
            <div class="input-group">
                <label for="serverUrl">ÏÑúÎ≤Ñ URL</label>
                <input type="text" id="serverUrl" value="http://localhost:3002" placeholder="http://localhost:3002">
            </div>
            <div class="input-group">
                <label for="accessToken">JWT Access Token</label>
                <input type="text" id="accessToken" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...">
            </div>
            <div class="input-group">
                <label for="plantId">Plant ID</label>
                <input type="number" id="plantId" value="1">
            </div>
        </div>

        <!-- ÏÉÅÌÉú ÏÑπÏÖò -->
        <div class="status-section">
            <div class="status-item">
                <div class="status-label">WebRTC ÏÉÅÌÉú</div>
                <div class="status-value disconnected" id="connectionStatus">ÎØ∏Ïó∞Í≤∞</div>
            </div>
            <div class="status-item">
                <div class="status-label">Data Channel</div>
                <div class="status-value disconnected" id="dataChannelStatus">Îã´Ìûò</div>
            </div>
            <div class="status-item">
                <div class="status-label">ÎßàÏù¥ÌÅ¨</div>
                <div class="status-value disconnected" id="micStatus">ÎåÄÍ∏∞</div>
            </div>
        </div>

        <!-- Î≤ÑÌäº Í∑∏Î£π -->
        <div class="button-group">
            <button class="btn-connect" id="connectBtn">Ïó∞Í≤∞ (WebRTC)</button>
            <button class="btn-disconnect" id="disconnectBtn" disabled>Ïó∞Í≤∞ Ìï¥Ï†ú</button>
        </div>

        <!-- ÎåÄÌôî ÎÇ¥Ïó≠ -->
        <div class="transcript-section">
            <div class="transcript-title">ÎåÄÌôî ÎÇ¥Ïó≠</div>
            <div id="transcript"></div>
        </div>

        <!-- Î°úÍ∑∏ -->
        <div class="logs" id="logs"></div>
    </div>

    <script>
        let peerConnection = null;
        let dataChannel = null;
        let audioElement = null;
        let localStream = null;

        const serverUrlInput = document.getElementById('serverUrl');
        const accessTokenInput = document.getElementById('accessToken');
        const plantIdInput = document.getElementById('plantId');
        const connectBtn = document.getElementById('connectBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const connectionStatus = document.getElementById('connectionStatus');
        const dataChannelStatus = document.getElementById('dataChannelStatus');
        const micStatus = document.getElementById('micStatus');
        const transcript = document.getElementById('transcript');
        const logs = document.getElementById('logs');

        // Î°úÍ∑∏ Ï∂úÎ†•
        function log(message, type = 'info') {
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logs.appendChild(entry);
            logs.scrollTop = logs.scrollHeight;
            console.log(message);
        }

        // ÎåÄÌôî ÎÇ¥Ïó≠ Ï∂îÍ∞Ä
        function addMessage(role, text) {
            const msg = document.createElement('div');
            msg.className = `message ${role}`;
            msg.textContent = `${role === 'user' ? 'ÎÇò' : 'ÏãùÎ¨º'}: ${text}`;
            transcript.appendChild(msg);
            transcript.scrollTop = transcript.scrollHeight;
        }

        function addSystemMessage(text) {
            const msg = document.createElement('div');
            msg.className = 'message system';
            msg.textContent = `[ÏãúÏä§ÌÖú] ${text}`;
            transcript.appendChild(msg);
            transcript.scrollTop = transcript.scrollHeight;
        }

        // WebRTC Ïó∞Í≤∞
        async function connect() {
            try {
                const serverUrl = serverUrlInput.value.trim();
                const token = accessTokenInput.value.trim();
                const plantId = plantIdInput.value;

                if (!serverUrl || !token || !plantId) {
                    alert('Î™®Îì† ÌïÑÎìúÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                    return;
                }

                log('Ephemeral token Î∞úÍ∏â ÏöîÏ≤≠ Ï§ë...', 'info');

                // 1. ÏÑúÎ≤ÑÏóêÏÑú ephemeral token Î∞úÍ∏â
                const response = await fetch(`${serverUrl}/chat/realtime/session`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ plantId: parseInt(plantId) })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    log(`ÏÑ∏ÏÖò ÏÉùÏÑ± Ïã§Ìå® (HTTP ${response.status}): ${errorText}`, 'error');
                    alert(`ÏÑ∏ÏÖò ÏÉùÏÑ± Ïã§Ìå® (HTTP ${response.status}): ${errorText}`);
                    return;
                }

                const data = await response.json();

                if (data.code !== 200) {
                    log(`ÏÑ∏ÏÖò ÏÉùÏÑ± Ïã§Ìå®: ${data.message || JSON.stringify(data)}`, 'error');
                    alert(`ÏÑ∏ÏÖò ÏÉùÏÑ± Ïã§Ìå®: ${data.message || JSON.stringify(data)}`);
                    return;
                }

                const { ephemeralToken, sessionId, expiresIn } = data.data;
                log(`‚úÖ Ephemeral token Î∞úÍ∏â ÏÑ±Í≥µ (Ïú†Ìö®: ${expiresIn}Ï¥à)`, 'success');
                log(`Session ID: ${sessionId}`, 'info');

                // 2. ÎßàÏù¥ÌÅ¨ Í∂åÌïú ÏöîÏ≤≠ Î∞è Ïä§Ìä∏Î¶º ÌöçÎìù
                log('ÎßàÏù¥ÌÅ¨ Í∂åÌïú ÏöîÏ≤≠ Ï§ë...', 'info');
                localStream = await navigator.mediaDevices.getUserMedia({
                    audio: true
                });
                log('‚úÖ ÎßàÏù¥ÌÅ¨ Ï†ëÍ∑º ÌóàÏö©Îê®', 'success');
                micStatus.textContent = 'ÌôúÏÑ±';
                micStatus.className = 'status-value connected';

                // 3. PeerConnection ÏÉùÏÑ±
                log('WebRTC PeerConnection ÏÉùÏÑ± Ï§ë...', 'info');
                peerConnection = new RTCPeerConnection();

                // 4. Î°úÏª¨ Ïò§ÎîîÏò§ Ìä∏Îûô Ï∂îÍ∞Ä (Opus ÏûêÎèô ÏÇ¨Ïö©)
                localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                    log(`‚úÖ Ïò§ÎîîÏò§ Ìä∏Îûô Ï∂îÍ∞ÄÎê® (Opus ÏΩîÎç± ÏûêÎèô)`, 'success');
                });

                // 5. Data Channel ÏÉùÏÑ± (OpenAI Ïù¥Î≤§Ìä∏ ÏàòÏã†Ïö©)
                dataChannel = peerConnection.createDataChannel('oai-events');

                dataChannel.onopen = () => {
                    log('‚úÖ Data Channel Ïó¥Î¶º', 'success');
                    dataChannelStatus.textContent = 'Ïó¥Î¶º';
                    dataChannelStatus.className = 'status-value connected';
                    addSystemMessage('Data channelÏù¥ Ïó¥Î†∏ÏäµÎãàÎã§. Ïù¥Ï†ú ÎåÄÌôîÎ•º ÏãúÏûëÌï† Ïàò ÏûàÏäµÎãàÎã§!');
                };

                dataChannel.onmessage = (event) => {
                    const message = JSON.parse(event.data);
                    handleServerMessage(message);
                };

                dataChannel.onclose = () => {
                    log('Data Channel Îã´Ìûò', 'info');
                    dataChannelStatus.textContent = 'Îã´Ìûò';
                    dataChannelStatus.className = 'status-value disconnected';
                };

                // 6. ÏõêÍ≤© Ïò§ÎîîÏò§ Ìä∏Îûô ÏàòÏã† (AI ÏùåÏÑ± Ïû¨ÏÉù)
                peerConnection.ontrack = (event) => {
                    log('‚úÖ ÏõêÍ≤© Ïò§ÎîîÏò§ Ìä∏Îûô ÏàòÏã†Îê®', 'success');

                    if (!audioElement) {
                        audioElement = new Audio();
                        audioElement.autoplay = true;
                    }

                    audioElement.srcObject = event.streams[0];
                    addSystemMessage('AI ÏùåÏÑ± Ïä§Ìä∏Î¶ºÏù¥ Ïó∞Í≤∞ÎêòÏóàÏäµÎãàÎã§.');
                };

                // 7. ICE Ïó∞Í≤∞ ÏÉÅÌÉú Î™®ÎãàÌÑ∞ÎßÅ
                peerConnection.oniceconnectionstatechange = () => {
                    log(`ICE Ïó∞Í≤∞ ÏÉÅÌÉú: ${peerConnection.iceConnectionState}`, 'info');

                    if (peerConnection.iceConnectionState === 'connected') {
                        connectionStatus.textContent = 'Ïó∞Í≤∞Îê®';
                        connectionStatus.className = 'status-value connected';
                        addSystemMessage('WebRTC Ïó∞Í≤∞Ïù¥ ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§!');
                    } else if (peerConnection.iceConnectionState === 'disconnected' ||
                               peerConnection.iceConnectionState === 'failed') {
                        connectionStatus.textContent = 'Ïó∞Í≤∞ ÎÅäÍπÄ';
                        connectionStatus.className = 'status-value disconnected';
                    }
                };

                // 8. SDP Offer ÏÉùÏÑ±
                log('SDP Offer ÏÉùÏÑ± Ï§ë...', 'info');
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);
                log('‚úÖ Local SDP ÏÑ§Ï†ï ÏôÑÎ£å', 'success');

                // 9. OpenAI WebRTC endpointÏóê SDP Ï†ÑÏÜ°
                log('OpenAIÏóê SDP Offer Ï†ÑÏÜ° Ï§ë...', 'info');
                const sdpResponse = await fetch('https://api.openai.com/v1/realtime', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${ephemeralToken}`,
                        'Content-Type': 'application/sdp',
                    },
                    body: offer.sdp,
                });

                if (!sdpResponse.ok) {
                    const errorText = await sdpResponse.text();
                    throw new Error(`OpenAI SDP ÏùëÎãµ Ïã§Ìå®: ${sdpResponse.status} ${errorText}`);
                }

                // 10. SDP Answer ÏàòÏã† Î∞è ÏÑ§Ï†ï
                const answerSdp = await sdpResponse.text();
                log('‚úÖ OpenAIÎ°úÎ∂ÄÌÑ∞ SDP Answer ÏàòÏã†', 'success');

                await peerConnection.setRemoteDescription({
                    type: 'answer',
                    sdp: answerSdp,
                });
                log('‚úÖ Remote SDP ÏÑ§Ï†ï ÏôÑÎ£å', 'success');

                // UI ÏóÖÎç∞Ïù¥Ìä∏
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
                addSystemMessage('WebRTC Ïó∞Í≤∞ ÏôÑÎ£å! ÏûêÏú†Î°≠Í≤å ÎßêÏîÄÌïòÏÑ∏Ïöî.');

            } catch (error) {
                log(`Ïó∞Í≤∞ Ïã§Ìå®: ${error.message}`, 'error');
                alert(`Ïó∞Í≤∞ Ïã§Ìå®: ${error.message}`);
                disconnect();
            }
        }

        // ÏÑúÎ≤Ñ Î©îÏãúÏßÄ Ï≤òÎ¶¨ (Data ChannelÏùÑ ÌÜµÌï¥ ÏàòÏã†)
        function handleServerMessage(message) {
            log(`üì• Ïù¥Î≤§Ìä∏: ${message.type}`, 'info');

            switch (message.type) {
                case 'session.created':
                    log('‚úÖ OpenAI ÏÑ∏ÏÖò ÏÉùÏÑ±Îê®', 'success');
                    addSystemMessage('AI ÏÑ∏ÏÖòÏù¥ ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§.');
                    break;

                case 'session.updated':
                    log('ÏÑ∏ÏÖò ÏÑ§Ï†ï ÏóÖÎç∞Ïù¥Ìä∏Îê®', 'info');
                    break;

                case 'conversation.item.input_audio_transcription.completed':
                    const userText = message.transcript;
                    addMessage('user', userText);
                    log(`üé§ ÏÇ¨Ïö©Ïûê: ${userText}`, 'success');
                    break;

                case 'response.audio_transcript.delta':
                    // AI ÏùëÎãµ ÌÖçÏä§Ìä∏ Ïä§Ìä∏Î¶¨Î∞ç
                    log(`üí¨ AI: ${message.delta}`, 'info');
                    break;

                case 'response.done':
                    const output = message.response?.output;
                    if (output && output.length > 0) {
                        const assistantMessages = output
                            .filter(item => item.type === 'message')
                            .map(item => {
                                const textContent = item.content?.find(c => c.type === 'text');
                                return textContent?.text || '';
                            })
                            .join(' ')
                            .trim();

                        if (assistantMessages) {
                            addMessage('assistant', assistantMessages);
                            log('‚úÖ AI ÏùëÎãµ ÏôÑÎ£å', 'success');
                        }
                    }
                    break;

                case 'error':
                    log(`‚ùå ÏóêÎü¨: ${message.error.message}`, 'error');
                    addSystemMessage(`ÏóêÎü¨: ${message.error.message}`);
                    break;

                default:
                    // Í∏∞ÌÉÄ Ïù¥Î≤§Ìä∏Îäî Î°úÍ∑∏Îßå
                    break;
            }
        }

        // Ïó∞Í≤∞ Ìï¥Ï†ú
        function disconnect() {
            log('Ïó∞Í≤∞ Ìï¥Ï†ú Ï§ë...', 'info');

            if (dataChannel) {
                dataChannel.close();
                dataChannel = null;
            }

            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }

            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }

            if (audioElement) {
                audioElement.pause();
                audioElement.srcObject = null;
                audioElement = null;
            }

            // UI ÏóÖÎç∞Ïù¥Ìä∏
            connectionStatus.textContent = 'ÎØ∏Ïó∞Í≤∞';
            connectionStatus.className = 'status-value disconnected';
            dataChannelStatus.textContent = 'Îã´Ìûò';
            dataChannelStatus.className = 'status-value disconnected';
            micStatus.textContent = 'ÎåÄÍ∏∞';
            micStatus.className = 'status-value disconnected';
            connectBtn.disabled = false;
            disconnectBtn.disabled = true;

            addSystemMessage('Ïó∞Í≤∞Ïù¥ Ï¢ÖÎ£åÎêòÏóàÏäµÎãàÎã§.');
            log('‚úÖ Ïó∞Í≤∞ Ìï¥Ï†ú ÏôÑÎ£å', 'success');
        }

        // Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà
        connectBtn.addEventListener('click', connect);
        disconnectBtn.addEventListener('click', disconnect);

        // Ï¥àÍ∏∞ Î°úÍ∑∏
        log('Leafy Realtime Voice Chat (WebRTC) Ï§ÄÎπÑ ÏôÑÎ£å', 'success');
        addSystemMessage('ÏÑ§Ï†ïÏùÑ ÏûÖÎ†•ÌïòÍ≥† "Ïó∞Í≤∞ (WebRTC)" Î≤ÑÌäºÏùÑ ÌÅ¥Î¶≠ÌïòÏÑ∏Ïöî.');
        addSystemMessage('WebRTCÎäî Opus ÏΩîÎç±ÏùÑ ÏûêÎèôÏúºÎ°ú ÏÇ¨Ïö©ÌïòÏó¨ Í≥†ÌíàÏßà ÏùåÏÑ±ÏùÑ Ï†úÍ≥µÌï©ÎãàÎã§.');
    </script>
</body>
</html>
