<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leafy Realtime Voice Chat (WebRTC + Opus)</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 700px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .badge {
            display: inline-block;
            background: #4caf50;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 20px;
        }

        .badge-container {
            text-align: center;
            margin-bottom: 20px;
        }

        .config-section {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .input-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 600;
            font-size: 14px;
        }

        input[type="text"],
        input[type="number"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus,
        input[type="number"]:focus {
            outline: none;
            border-color: #667eea;
        }

        .status-section {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 10px;
        }

        .status-item {
            text-align: center;
        }

        .status-label {
            font-size: 11px;
            color: #666;
            margin-bottom: 5px;
        }

        .status-value {
            font-size: 16px;
            font-weight: bold;
        }

        .status-value.connected {
            color: #4caf50;
        }

        .status-value.disconnected {
            color: #f44336;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        button {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-connect {
            background: #4caf50;
            color: white;
        }

        .btn-connect:hover:not(:disabled) {
            background: #45a049;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);
        }

        .btn-disconnect {
            background: #f44336;
            color: white;
        }

        .btn-disconnect:hover:not(:disabled) {
            background: #da190b;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(244, 67, 54, 0.4);
        }

        .transcript-section {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 10px;
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .transcript-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: #333;
        }

        .message {
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 8px;
            line-height: 1.5;
        }

        .message.user {
            background: #e3f2fd;
            color: #1976d2;
        }

        .message.assistant {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        .message.system {
            background: #fff3e0;
            color: #f57c00;
            font-size: 13px;
        }

        .logs {
            background: #263238;
            color: #aed581;
            padding: 15px;
            border-radius: 10px;
            max-height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.6;
        }

        .log-entry {
            margin-bottom: 5px;
        }

        .log-entry.error {
            color: #ff5252;
        }

        .log-entry.success {
            color: #69f0ae;
        }

        .log-entry.info {
            color: #64b5f6;
        }

        .info-box {
            background: #e8f5e9;
            border-left: 4px solid #4caf50;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            font-size: 13px;
        }

        .info-box strong {
            color: #2e7d32;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸŒ± Leafy Realtime Voice Chat</h1>
        <p class="subtitle">OpenAI Realtime API - WebRTC í…ŒìŠ¤íŠ¸</p>
        <div class="badge-container">
            <span class="badge">âœ¨ WebRTC + Opus (ê³ í’ˆì§ˆ)</span>
        </div>

        <div class="info-box">
            <strong>ğŸ¯ WebRTC ë°©ì‹ì˜ ì¥ì :</strong><br>
            â€¢ Opus ì½”ë± ìë™ ì‚¬ìš© (ìµœëŒ€ 48kHz)<br>
            â€¢ ì„œë²„ ë¶€í•˜ ì—†ìŒ (ì§ì ‘ OpenAI ì—°ê²°)<br>
            â€¢ ìë™ ë„¤íŠ¸ì›Œí¬ ì ì‘ & íŒ¨í‚· ì†ì‹¤ ë³µêµ¬
        </div>

        <!-- ì„¤ì • ì„¹ì…˜ -->
        <div class="config-section">
            <div class="input-group">
                <label for="serverUrl">ì„œë²„ URL</label>
                <input type="text" id="serverUrl" value="http://localhost:3002" placeholder="http://localhost:3002">
            </div>
            <div class="input-group">
                <label for="accessToken">JWT Access Token</label>
                <input type="text" id="accessToken" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...">
            </div>
            <div class="input-group">
                <label for="plantId">Plant ID</label>
                <input type="number" id="plantId" value="1">
            </div>
        </div>

        <!-- ìƒíƒœ ì„¹ì…˜ -->
        <div class="status-section">
            <div class="status-item">
                <div class="status-label">WebRTC ìƒíƒœ</div>
                <div class="status-value disconnected" id="connectionStatus">ë¯¸ì—°ê²°</div>
            </div>
            <div class="status-item">
                <div class="status-label">Data Channel</div>
                <div class="status-value disconnected" id="dataChannelStatus">ë‹«í˜</div>
            </div>
            <div class="status-item">
                <div class="status-label">ë§ˆì´í¬</div>
                <div class="status-value disconnected" id="micStatus">ëŒ€ê¸°</div>
            </div>
        </div>

        <!-- ë²„íŠ¼ ê·¸ë£¹ -->
        <div class="button-group">
            <button class="btn-connect" id="connectBtn">ì—°ê²° (WebRTC)</button>
            <button class="btn-disconnect" id="disconnectBtn" disabled>ì—°ê²° í•´ì œ</button>
        </div>

        <!-- ëŒ€í™” ë‚´ì—­ -->
        <div class="transcript-section">
            <div class="transcript-title">ëŒ€í™” ë‚´ì—­</div>
            <div id="transcript"></div>
        </div>

        <!-- ë¡œê·¸ -->
        <div class="logs" id="logs"></div>
    </div>

    <script>
        let peerConnection = null;
        let dataChannel = null;
        let audioElement = null;
        let localStream = null;

        const serverUrlInput = document.getElementById('serverUrl');
        const accessTokenInput = document.getElementById('accessToken');
        const plantIdInput = document.getElementById('plantId');
        const connectBtn = document.getElementById('connectBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const connectionStatus = document.getElementById('connectionStatus');
        const dataChannelStatus = document.getElementById('dataChannelStatus');
        const micStatus = document.getElementById('micStatus');
        const transcript = document.getElementById('transcript');
        const logs = document.getElementById('logs');

        // ë¡œê·¸ ì¶œë ¥
        function log(message, type = 'info') {
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logs.appendChild(entry);
            logs.scrollTop = logs.scrollHeight;
            console.log(message);
        }

        // ëŒ€í™” ë‚´ì—­ ì¶”ê°€
        function addMessage(role, text) {
            const msg = document.createElement('div');
            msg.className = `message ${role}`;
            msg.textContent = `${role === 'user' ? 'ë‚˜' : 'ì‹ë¬¼'}: ${text}`;
            transcript.appendChild(msg);
            transcript.scrollTop = transcript.scrollHeight;
        }

        function addSystemMessage(text) {
            const msg = document.createElement('div');
            msg.className = 'message system';
            msg.textContent = `[ì‹œìŠ¤í…œ] ${text}`;
            transcript.appendChild(msg);
            transcript.scrollTop = transcript.scrollHeight;
        }

        // WebRTC ì—°ê²°
        async function connect() {
            try {
                const serverUrl = serverUrlInput.value.trim();
                const token = accessTokenInput.value.trim();
                const plantId = plantIdInput.value;

                if (!serverUrl || !token || !plantId) {
                    alert('ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }

                log('Ephemeral token ë°œê¸‰ ìš”ì²­ ì¤‘...', 'info');

                // 1. ì„œë²„ì—ì„œ ephemeral token ë°œê¸‰
                const response = await fetch(`${serverUrl}/chat/realtime/session`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ plantId: parseInt(plantId) })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    log(`ì„¸ì…˜ ìƒì„± ì‹¤íŒ¨ (HTTP ${response.status}): ${errorText}`, 'error');
                    alert(`ì„¸ì…˜ ìƒì„± ì‹¤íŒ¨ (HTTP ${response.status}): ${errorText}`);
                    return;
                }

                const data = await response.json();

                if (data.code !== 200) {
                    log(`ì„¸ì…˜ ìƒì„± ì‹¤íŒ¨: ${data.message || JSON.stringify(data)}`, 'error');
                    alert(`ì„¸ì…˜ ìƒì„± ì‹¤íŒ¨: ${data.message || JSON.stringify(data)}`);
                    return;
                }

                const { ephemeralToken, sessionId, expiresIn } = data.data;
                log(`âœ… Ephemeral token ë°œê¸‰ ì„±ê³µ (ìœ íš¨: ${expiresIn}ì´ˆ)`, 'success');
                log(`Session ID: ${sessionId}`, 'info');

                // 2. ë§ˆì´í¬ ê¶Œí•œ ìš”ì²­ ë° ìŠ¤íŠ¸ë¦¼ íšë“
                log('ë§ˆì´í¬ ê¶Œí•œ ìš”ì²­ ì¤‘...', 'info');
                localStream = await navigator.mediaDevices.getUserMedia({
                    audio: true
                });
                log('âœ… ë§ˆì´í¬ ì ‘ê·¼ í—ˆìš©ë¨', 'success');
                micStatus.textContent = 'í™œì„±';
                micStatus.className = 'status-value connected';

                // 3. PeerConnection ìƒì„±
                log('WebRTC PeerConnection ìƒì„± ì¤‘...', 'info');
                peerConnection = new RTCPeerConnection();

                // 4. ë¡œì»¬ ì˜¤ë””ì˜¤ íŠ¸ë™ ì¶”ê°€ (Opus ìë™ ì‚¬ìš©)
                localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                    log(`âœ… ì˜¤ë””ì˜¤ íŠ¸ë™ ì¶”ê°€ë¨ (Opus ì½”ë± ìë™)`, 'success');
                });

                // 5. Data Channel ìƒì„± (OpenAI ì´ë²¤íŠ¸ ìˆ˜ì‹ ìš©)
                dataChannel = peerConnection.createDataChannel('oai-events');

                dataChannel.onopen = () => {
                    log('âœ… Data Channel ì—´ë¦¼', 'success');
                    dataChannelStatus.textContent = 'ì—´ë¦¼';
                    dataChannelStatus.className = 'status-value connected';
                    addSystemMessage('Data channelì´ ì—´ë ¸ìŠµë‹ˆë‹¤. ì´ì œ ëŒ€í™”ë¥¼ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!');
                };

                dataChannel.onmessage = (event) => {
                    const message = JSON.parse(event.data);
                    handleServerMessage(message);
                };

                dataChannel.onclose = () => {
                    log('Data Channel ë‹«í˜', 'info');
                    dataChannelStatus.textContent = 'ë‹«í˜';
                    dataChannelStatus.className = 'status-value disconnected';
                };

                // 6. ì›ê²© ì˜¤ë””ì˜¤ íŠ¸ë™ ìˆ˜ì‹  (AI ìŒì„± ì¬ìƒ)
                peerConnection.ontrack = (event) => {
                    log('âœ… ì›ê²© ì˜¤ë””ì˜¤ íŠ¸ë™ ìˆ˜ì‹ ë¨', 'success');

                    if (!audioElement) {
                        audioElement = new Audio();
                        audioElement.autoplay = true;
                    }

                    audioElement.srcObject = event.streams[0];
                    addSystemMessage('AI ìŒì„± ìŠ¤íŠ¸ë¦¼ì´ ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤.');
                };

                // 7. ICE ì—°ê²° ìƒíƒœ ëª¨ë‹ˆí„°ë§
                peerConnection.oniceconnectionstatechange = () => {
                    log(`ICE ì—°ê²° ìƒíƒœ: ${peerConnection.iceConnectionState}`, 'info');

                    if (peerConnection.iceConnectionState === 'connected') {
                        connectionStatus.textContent = 'ì—°ê²°ë¨';
                        connectionStatus.className = 'status-value connected';
                        addSystemMessage('WebRTC ì—°ê²°ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
                    } else if (peerConnection.iceConnectionState === 'disconnected' ||
                               peerConnection.iceConnectionState === 'failed') {
                        connectionStatus.textContent = 'ì—°ê²° ëŠê¹€';
                        connectionStatus.className = 'status-value disconnected';
                    }
                };

                // 8. SDP Offer ìƒì„±
                log('SDP Offer ìƒì„± ì¤‘...', 'info');
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);
                log('âœ… Local SDP ì„¤ì • ì™„ë£Œ', 'success');

                // 9. OpenAI WebRTC endpointì— SDP ì „ì†¡
                log('OpenAIì— SDP Offer ì „ì†¡ ì¤‘...', 'info');
                const sdpResponse = await fetch('https://api.openai.com/v1/realtime', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${ephemeralToken}`,
                        'Content-Type': 'application/sdp',
                    },
                    body: offer.sdp,
                });

                if (!sdpResponse.ok) {
                    const errorText = await sdpResponse.text();
                    throw new Error(`OpenAI SDP ì‘ë‹µ ì‹¤íŒ¨: ${sdpResponse.status} ${errorText}`);
                }

                // 10. SDP Answer ìˆ˜ì‹  ë° ì„¤ì •
                const answerSdp = await sdpResponse.text();
                log('âœ… OpenAIë¡œë¶€í„° SDP Answer ìˆ˜ì‹ ', 'success');

                await peerConnection.setRemoteDescription({
                    type: 'answer',
                    sdp: answerSdp,
                });
                log('âœ… Remote SDP ì„¤ì • ì™„ë£Œ', 'success');

                // UI ì—…ë°ì´íŠ¸
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
                addSystemMessage('WebRTC ì—°ê²° ì™„ë£Œ! ììœ ë¡­ê²Œ ë§ì”€í•˜ì„¸ìš”.');

            } catch (error) {
                log(`ì—°ê²° ì‹¤íŒ¨: ${error.message}`, 'error');
                alert(`ì—°ê²° ì‹¤íŒ¨: ${error.message}`);
                disconnect();
            }
        }

        // ì„œë²„ ë©”ì‹œì§€ ì²˜ë¦¬ (Data Channelì„ í†µí•´ ìˆ˜ì‹ )
        function handleServerMessage(message) {
            log(`ğŸ“¥ ì´ë²¤íŠ¸: ${message.type}`, 'info');

            switch (message.type) {
                case 'session.created':
                    log('âœ… OpenAI ì„¸ì…˜ ìƒì„±ë¨', 'success');
                    addSystemMessage('AI ì„¸ì…˜ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    break;

                case 'session.updated':
                    log('ì„¸ì…˜ ì„¤ì • ì—…ë°ì´íŠ¸ë¨', 'info');
                    break;

                case 'conversation.item.input_audio_transcription.completed':
                    const userText = message.transcript;
                    addMessage('user', userText);
                    log(`ğŸ¤ ì‚¬ìš©ì: ${userText}`, 'success');
                    break;

                case 'response.audio_transcript.delta':
                    // AI ì‘ë‹µ í…ìŠ¤íŠ¸ ìŠ¤íŠ¸ë¦¬ë°
                    log(`ğŸ’¬ AI: ${message.delta}`, 'info');
                    break;

                case 'response.done':
                    const output = message.response?.output;
                    if (output && output.length > 0) {
                        const assistantMessages = output
                            .filter(item => item.type === 'message')
                            .map(item => {
                                const textContent = item.content?.find(c => c.type === 'text');
                                return textContent?.text || '';
                            })
                            .join(' ')
                            .trim();

                        if (assistantMessages) {
                            addMessage('assistant', assistantMessages);
                            log('âœ… AI ì‘ë‹µ ì™„ë£Œ', 'success');
                        }
                    }
                    break;

                case 'error':
                    log(`âŒ ì—ëŸ¬: ${message.error.message}`, 'error');
                    addSystemMessage(`ì—ëŸ¬: ${message.error.message}`);
                    break;

                default:
                    // ê¸°íƒ€ ì´ë²¤íŠ¸ëŠ” ë¡œê·¸ë§Œ
                    break;
            }
        }

        // ì—°ê²° í•´ì œ
        function disconnect() {
            log('ì—°ê²° í•´ì œ ì¤‘...', 'info');

            if (dataChannel) {
                dataChannel.close();
                dataChannel = null;
            }

            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }

            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }

            if (audioElement) {
                audioElement.pause();
                audioElement.srcObject = null;
                audioElement = null;
            }

            // UI ì—…ë°ì´íŠ¸
            connectionStatus.textContent = 'ë¯¸ì—°ê²°';
            connectionStatus.className = 'status-value disconnected';
            dataChannelStatus.textContent = 'ë‹«í˜';
            dataChannelStatus.className = 'status-value disconnected';
            micStatus.textContent = 'ëŒ€ê¸°';
            micStatus.className = 'status-value disconnected';
            connectBtn.disabled = false;
            disconnectBtn.disabled = true;

            addSystemMessage('ì—°ê²°ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
            log('âœ… ì—°ê²° í•´ì œ ì™„ë£Œ', 'success');
        }

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        connectBtn.addEventListener('click', connect);
        disconnectBtn.addEventListener('click', disconnect);

        // ì´ˆê¸° ë¡œê·¸
        log('Leafy Realtime Voice Chat (WebRTC) ì¤€ë¹„ ì™„ë£Œ', 'success');
        addSystemMessage('ì„¤ì •ì„ ì…ë ¥í•˜ê³  "ì—°ê²° (WebRTC)" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.');
        addSystemMessage('WebRTCëŠ” Opus ì½”ë±ì„ ìë™ìœ¼ë¡œ ì‚¬ìš©í•˜ì—¬ ê³ í’ˆì§ˆ ìŒì„±ì„ ì œê³µí•©ë‹ˆë‹¤.');
    </script>
</body>
</html>
